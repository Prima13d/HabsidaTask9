<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Admin users</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body class="container mt-4">

<div th:replace="fragments/navbar :: navbar"></div>
<br>

<h2>Admin panel</h2>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#usersTab">
            Users
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#addUserTab">
            Add user
        </button>
    </li>
</ul>

<div class="tab-content">

    <!-- USERS TABLE -->
    <div class="tab-pane fade show active" id="usersTab">

        <table class="table table-bordered table-striped">
            <thead>
            <tr>
                <th>ID</th>
                <th>First name</th>
                <th>Family name</th>
                <th>Actions</th>
            </tr>
            </thead>

            <tbody id="usersTableBody"></tbody>
        </table>

    </div>

    <!-- ADD USER -->
    <div class="tab-pane fade" id="addUserTab">

        <form class="col-6">

            <div class="mb-2">
                <label>First name</label>
                <input class="form-control" name="userFirstName" required>
            </div>

            <div class="mb-2">
                <label>Family name</label>
                <input class="form-control" name="userFamilyName" required>
            </div>

            <div class="mb-2">
                <label>Username</label>
                <input class="form-control" name="username" required>
            </div>

            <div class="mb-2">
                <label>Password</label>
                <input type="password" class="form-control" name="password" required>
            </div>

            <div class="mb-3">
                <label>Role</label><br>
                <input type="radio" name="role" value="ADMIN"> ADMIN<br>
                <input type="radio" name="role" value="USER" checked> USER
            </div>

            <button class="btn btn-success">Save</button>
        </form>

    </div>
</div>

<a th:href="@{/}" class="btn btn-secondary mt-4">Back to home</a>

<!-- EDIT MODAL -->
<div class="modal fade" id="editUserModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="editForm">

                <div class="modal-header">
                    <h5>Edit user</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="edit-id">

                    <div class="mb-2">
                        <label>First name</label>
                        <input class="form-control" id="edit-first">
                    </div>

                    <div class="mb-2">
                        <label>Family name</label>
                        <input class="form-control" id="edit-family">
                    </div>

                    <div class="mb-2">
                        <label>Password</label>
                        <input type="password" class="form-control" id="edit-password">
                    </div>

                    <div class="mb-3">
                        <label>Role</label><br>

                        <input type="radio" name="edit-role" value="ADMIN" id="role-admin">
                        <label for="role-admin">ADMIN</label><br>

                        <input type="radio" name="edit-role" value="USER" id="role-user" checked>
                        <label for="role-user">USER</label>
                    </div>


                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-success">Save</button>
                </div>

            </form>

        </div>
    </div>
</div>

<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    const tableBody = document.getElementById('usersTableBody');
</script>

<script>
    function loadUsers() {
        fetch('/api/admin/users')
            .then(res => res.json())
            .then(users => {
                tableBody.innerHTML = '';

                users.forEach(user => {
                    tableBody.innerHTML += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.userFirstName}</td>
                            <td>${user.userFamilyName}</td>
                            <td>
                                <button class="btn btn-warning btn-sm"
                                        onclick="openEditModal(${user.id},
                                            '${user.userFirstName}',
                                            '${user.userFamilyName}')">
                                    Edit
                                </button>

                                <button class="btn btn-danger btn-sm ms-1"
                                        onclick="deleteUser(${user.id})">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
    }

    loadUsers();
</script>

<script>
    function deleteUser(id) {
        if (!confirm('Delete user?')) return;

        fetch(`/api/admin/users/${id}`, {
            method: 'DELETE',
            headers: {
                [csrfHeader]: csrfToken
            }
        }).then(loadUsers);
    }
</script>

<script>
    function openEditModal(id, first, family, role = 'USER') {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-first').value = first;
        document.getElementById('edit-family').value = family;
        document.getElementById('edit-password').value = '';

        document.querySelectorAll('input[name="edit-role"]')
            .forEach(r => r.checked = (r.value === role));

        new bootstrap.Modal(
            document.getElementById('editUserModal')
        ).show();
    }
</script>

<script>
    document.getElementById('editForm')
        .addEventListener('submit', e => {
            e.preventDefault();

            const id = document.getElementById('edit-id').value;

            const role = document.querySelector(
                'input[name="edit-role"]:checked'
            ).value;

            fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    userFirstName: document.getElementById('edit-first').value,
                    userFamilyName: document.getElementById('edit-family').value,
                    password: document.getElementById('edit-password').value,
                    role: role
                })
            }).then(() => {
                bootstrap.Modal
                    .getInstance(document.getElementById('editUserModal'))
                    .hide();
                loadUsers();
            });
        });
</script>

<script>
    document.querySelector('#addUserTab form')
        .addEventListener('submit', e => {
            e.preventDefault();

            const f = e.target;

            fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    userFirstName: f.userFirstName.value,
                    userFamilyName: f.userFamilyName.value,
                    username: f.username.value,
                    password: f.password.value,
                    role: f.role.value
                })
            }).then(() => {
                f.reset();
                loadUsers();
            });
        });
</script>

</body>
</html>
